<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Inspection Scoring Analysis - Ramsey Shops</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    .tab-btn { transition: all 0.2s; }
    .tab-btn.active { border-bottom: 2px solid #3b82f6; color: #3b82f6; }
    .tab-btn:not(.active) { border-bottom: 2px solid transparent; color: #6b7280; }
    .tab-btn:hover:not(.active) { color: #374151; }
    .heat-good { background-color: #bbf7d0; }
    .heat-ok { background-color: #fef9c3; }
    .heat-bad { background-color: #fecaca; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <div class="max-w-7xl mx-auto p-4">
    <!-- Header -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
      <h1 class="text-2xl font-bold text-gray-800">Inspection Scoring Analysis</h1>
      <p class="text-gray-600 mt-1">AutoVitals DVI Metrics - Ramsey Shops Data</p>
      <div class="mt-3 inline-flex items-center px-3 py-1 rounded-full bg-amber-100 text-amber-800 text-sm">
        ‚ö†Ô∏è This analysis is based on Ramsey shops data only (22,999 inspections over 12 months)
      </div>
    </div>

    <!-- Main Content -->
    <div class="bg-white rounded-lg shadow-lg p-6">
      <!-- Tabs -->
      <div class="flex border-b border-gray-200 mb-6">
        <button class="tab-btn active px-4 py-2 text-sm font-medium" data-tab="explorer">üìä Data Explorer</button>
        <button class="tab-btn px-4 py-2 text-sm font-medium" data-tab="benchmarks">üìà Benchmarks</button>
        <button class="tab-btn px-4 py-2 text-sm font-medium" data-tab="simulator">üéØ Scoring Simulator</button>
      </div>

      <!-- Tab Content -->
      <div id="explorer-tab" class="tab-content">
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
          <p class="text-blue-800 text-sm">
            <strong>üìä Data Explorer:</strong> Filter and group the data to understand inspection patterns across vehicle segments. 
            This data represents <strong id="total-inspections">22,999</strong> inspections from Ramsey shops.
          </p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Group By</label>
            <select id="groupBy" class="w-full border rounded-md px-3 py-2 text-sm">
              <option value="both">Age + Mileage</option>
              <option value="age">Vehicle Age Only</option>
              <option value="mileage">Mileage Only</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Vehicle Age Filter</label>
            <select id="ageFilter" class="w-full border rounded-md px-3 py-2 text-sm">
              <option value="all">All Ages</option>
              <option value="0 3 Years">0-3 Years</option>
              <option value="4 6 Years">4-6 Years</option>
              <option value="7 10 Years">7-10 Years</option>
              <option value="10 Years">10+ Years</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Mileage Filter</label>
            <select id="mileageFilter" class="w-full border rounded-md px-3 py-2 text-sm">
              <option value="all">All Mileages</option>
              <option value="0-50K">0-50K</option>
              <option value="50K-100K">50K-100K</option>
              <option value="100K-150K">100K-150K</option>
              <option value="150K+">150K+</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Metric</label>
            <select id="metricSelect" class="w-full border rounded-md px-3 py-2 text-sm">
              <option value="avg_issues_found">Avg Issues Found</option>
              <option value="avg_maintenance_conditions">Avg Maintenance Conditions</option>
              <option value="avg_repair_conditions">Avg Repair Conditions</option>
              <option value="avg_images">Avg Images</option>
              <option value="avg_edited_images">Avg Edited Images</option>
              <option value="rate_recommendations_with_image">Recommendations w/ Image Rate</option>
              <option value="rate_edited_images">Edited Image Rate</option>
            </select>
          </div>
        </div>

        <div class="bg-white rounded-lg shadow p-4 mb-6">
          <h3 class="text-lg font-semibold mb-4" id="chart-title">Avg Issues Found by Segment</h3>
          <div style="height: 400px;">
            <canvas id="explorerChart"></canvas>
          </div>
        </div>

        <div class="bg-white rounded-lg shadow overflow-hidden">
          <h3 class="text-lg font-semibold p-4 border-b">Detailed Data</h3>
          <div class="overflow-x-auto">
            <table class="min-w-full text-sm" id="dataTable">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-4 py-2 text-left">Segment</th>
                  <th class="px-4 py-2 text-right">Inspections</th>
                  <th class="px-4 py-2 text-right">Issues Found</th>
                  <th class="px-4 py-2 text-right">Maint. Cond.</th>
                  <th class="px-4 py-2 text-right">Repair Cond.</th>
                  <th class="px-4 py-2 text-right">Images</th>
                  <th class="px-4 py-2 text-right">Edited %</th>
                  <th class="px-4 py-2 text-right">Rec w/ Image</th>
                </tr>
              </thead>
              <tbody id="dataTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="benchmarks-tab" class="tab-content hidden">
        <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
          <p class="text-green-800 text-sm">
            <strong>üìà Benchmarks & Recommendations:</strong> Based on 22,999 Ramsey inspections, 
            these benchmarks help define "good" vs "needs improvement" thresholds by vehicle segment.
          </p>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
          <div class="bg-white rounded-lg shadow p-4 border-l-4 border-red-500">
            <div class="text-sm font-medium text-gray-500">Avg Issues Found</div>
            <div class="text-2xl font-bold mt-1 text-red-500">10.3</div>
            <div class="text-xs text-gray-400 mt-1">per inspection</div>
          </div>
          <div class="bg-white rounded-lg shadow p-4 border-l-4 border-blue-500">
            <div class="text-sm font-medium text-gray-500">Avg Images</div>
            <div class="text-2xl font-bold mt-1 text-blue-500">33.8</div>
            <div class="text-xs text-gray-400 mt-1">per inspection</div>
          </div>
          <div class="bg-white rounded-lg shadow p-4 border-l-4 border-green-500">
            <div class="text-sm font-medium text-gray-500">Rec w/ Image Rate</div>
            <div class="text-2xl font-bold mt-1 text-green-500">79.6%</div>
            <div class="text-xs text-gray-400 mt-1">target: 85%+</div>
          </div>
          <div class="bg-white rounded-lg shadow p-4 border-l-4 border-purple-500">
            <div class="text-sm font-medium text-gray-500">Edited Image Rate</div>
            <div class="text-2xl font-bold mt-1 text-purple-500">4.0%</div>
            <div class="text-xs text-gray-400 mt-1">current baseline</div>
          </div>
        </div>

        <div class="flex gap-2 mb-4">
          <button id="matrixViewBtn" class="px-4 py-2 rounded text-sm bg-blue-500 text-white">Heat Map Matrix</button>
          <button id="thresholdsViewBtn" class="px-4 py-2 rounded text-sm bg-gray-200">Suggested Thresholds</button>
        </div>

        <div id="matrixView">
          <div class="space-y-6" id="heatmapContainer"></div>
        </div>

        <div id="thresholdsView" class="hidden">
          <div class="bg-white rounded-lg shadow overflow-hidden">
            <h3 class="text-lg font-semibold p-4 border-b">Suggested Thresholds by Segment</h3>
            <div class="overflow-x-auto">
              <table class="min-w-full text-sm">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-3 py-2 text-left">Vehicle Age</th>
                    <th class="px-3 py-2 text-left">Mileage</th>
                    <th class="px-3 py-2 text-center">Expected Issues</th>
                    <th class="px-3 py-2 text-center">Expected Maint.</th>
                    <th class="px-3 py-2 text-center">Expected Repair</th>
                    <th class="px-3 py-2 text-center">Min Images</th>
                    <th class="px-3 py-2 text-center">Target Images</th>
                    <th class="px-3 py-2 text-center">Min Rec w/ Img</th>
                  </tr>
                </thead>
                <tbody id="thresholdsTableBody"></tbody>
              </table>
            </div>
            <div class="p-4 bg-yellow-50 border-t text-sm text-yellow-800">
              <strong>üí° Key Insight:</strong> Older vehicles with higher mileage should have MORE issues found, not fewer. 
              An inspection on a 10+ year vehicle with 150K+ miles showing only 5 issues may indicate incomplete inspection.
            </div>
          </div>
        </div>
      </div>

      <div id="simulator-tab" class="tab-content hidden">
        <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 mb-6">
          <p class="text-purple-800 text-sm">
            <strong>üéØ Scoring Simulator:</strong> Adjust the weights below to see how different scoring models 
            would grade the Ramsey shop inspections. This helps determine the optimal scoring configuration.
          </p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
          <div class="bg-white rounded-lg shadow p-4">
            <h3 class="text-lg font-semibold mb-4">Scoring Weights</h3>
            <div class="space-y-4">
              <div class="flex items-center gap-4">
                <div class="flex-1">
                  <label class="block text-sm font-medium"># of Recommendations Found</label>
                  <span class="text-xs text-gray-500">Issues identified during inspection</span>
                </div>
                <input type="range" min="0" max="50" value="20" id="weight_issues" class="w-32">
                <span class="w-12 text-right font-mono text-sm" id="weight_issues_val">20%</span>
              </div>
              <div class="flex items-center gap-4">
                <div class="flex-1">
                  <label class="block text-sm font-medium"># of Maintenance Conditions</label>
                  <span class="text-xs text-gray-500">Time/mileage-based services</span>
                </div>
                <input type="range" min="0" max="50" value="15" id="weight_maint" class="w-32">
                <span class="w-12 text-right font-mono text-sm" id="weight_maint_val">15%</span>
              </div>
              <div class="flex items-center gap-4">
                <div class="flex-1">
                  <label class="block text-sm font-medium"># of Repair Conditions</label>
                  <span class="text-xs text-gray-500">Condition-based repairs needed</span>
                </div>
                <input type="range" min="0" max="50" value="15" id="weight_repair" class="w-32">
                <span class="w-12 text-right font-mono text-sm" id="weight_repair_val">15%</span>
              </div>
              <div class="flex items-center gap-4">
                <div class="flex-1">
                  <label class="block text-sm font-medium"># of Images Taken</label>
                  <span class="text-xs text-gray-500">Photo documentation</span>
                </div>
                <input type="range" min="0" max="50" value="25" id="weight_images" class="w-32">
                <span class="w-12 text-right font-mono text-sm" id="weight_images_val">25%</span>
              </div>
              <div class="flex items-center gap-4">
                <div class="flex-1">
                  <label class="block text-sm font-medium">Recommendations w/ Images %</label>
                  <span class="text-xs text-gray-500">Photo support for findings</span>
                </div>
                <input type="range" min="0" max="50" value="25" id="weight_recimg" class="w-32">
                <span class="w-12 text-right font-mono text-sm" id="weight_recimg_val">25%</span>
              </div>
            </div>
            <div id="totalWeightIndicator" class="mt-4 p-2 rounded text-sm bg-green-100 text-green-800">
              Total Weight: 100%
            </div>
          </div>

          <div class="bg-white rounded-lg shadow p-4">
            <h3 class="text-lg font-semibold mb-4">Grade Thresholds</h3>
            <div class="space-y-4">
              <div class="flex items-center gap-4">
                <div class="flex-1">
                  <label class="block text-sm font-medium">Excellent</label>
                  <span class="text-xs text-gray-500" id="excellent_desc">Score ‚â• 95</span>
                </div>
                <input type="range" min="0" max="100" value="95" id="threshold_excellent" class="w-32">
                <span class="w-12 text-right font-mono text-sm" id="threshold_excellent_val">95</span>
              </div>
              <div class="flex items-center gap-4">
                <div class="flex-1">
                  <label class="block text-sm font-medium">Good</label>
                  <span class="text-xs text-gray-500" id="good_desc">Score ‚â• 80</span>
                </div>
                <input type="range" min="0" max="100" value="80" id="threshold_good" class="w-32">
                <span class="w-12 text-right font-mono text-sm" id="threshold_good_val">80</span>
              </div>
              <div class="flex items-center gap-4">
                <div class="flex-1">
                  <label class="block text-sm font-medium">Needs Improvement</label>
                  <span class="text-xs text-gray-500" id="needs_desc">Score ‚â• 60</span>
                </div>
                <input type="range" min="0" max="100" value="60" id="threshold_needs" class="w-32">
                <span class="w-12 text-right font-mono text-sm" id="threshold_needs_val">60</span>
              </div>
              <div class="text-sm text-gray-500 mt-2">
                <span class="text-red-500 font-medium">Poor:</span> Score &lt; <span id="poor_threshold">60</span>
              </div>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
          <div class="bg-white rounded-lg shadow p-4">
            <h3 class="text-lg font-semibold mb-4">Score Distribution (by Inspection Count)</h3>
            <div style="height: 250px;">
              <canvas id="distributionChart"></canvas>
            </div>
            <div class="flex justify-center gap-4 mt-2 text-sm flex-wrap" id="distributionLegend"></div>
          </div>

          <div class="bg-white rounded-lg shadow p-4">
            <h3 class="text-lg font-semibold mb-4">Scores by Segment</h3>
            <div style="height: 250px;">
              <canvas id="segmentChart"></canvas>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-lg shadow overflow-hidden">
          <h3 class="text-lg font-semibold p-4 border-b">Detailed Score Breakdown</h3>
          <div class="overflow-x-auto">
            <table class="min-w-full text-sm">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-3 py-2 text-left">Segment</th>
                  <th class="px-3 py-2 text-center">Count</th>
                  <th class="px-3 py-2 text-center">Issues</th>
                  <th class="px-3 py-2 text-center">Maint.</th>
                  <th class="px-3 py-2 text-center">Repair</th>
                  <th class="px-3 py-2 text-center">Images</th>
                  <th class="px-3 py-2 text-center">Rec w/Img</th>
                  <th class="px-3 py-2 text-center font-bold">Total</th>
                  <th class="px-3 py-2 text-center">Grade</th>
                </tr>
              </thead>
              <tbody id="scoreTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="mt-6 bg-gray-800 rounded-lg p-4 text-gray-300 text-sm">
      <h4 class="font-semibold text-white mb-2">üìã Methodology Notes</h4>
      <ul class="space-y-1 text-xs">
        <li>‚Ä¢ <strong>Maintenance Conditions:</strong> Time/mileage-based services (oil, filters, fluid exchanges, factory schedules)</li>
        <li>‚Ä¢ <strong>Repair Conditions:</strong> Condition-based issues (leaks, wear, damage, broken parts, low measurements)</li>
        <li>‚Ä¢ <strong>Topic Completion Rate:</strong> Nearly 100% across all segments (inspections are thorough)</li>
        <li>‚Ä¢ <strong>Scoring is segment-aware:</strong> Older/higher-mileage vehicles are expected to have MORE findings</li>
        <li>‚Ä¢ <strong>Data Source:</strong> avdbprod.dbo tables - VEISInspectionResult, EISTopicResult, EISTopicResultCondition</li>
      </ul>
    </div>
  </div>

  <script>
    // Data
    const rawData = [
      { vehicle_age_range: "0 3 Years", mileage_range: "0-50K", inspection_count: 2064, avg_issues_found: 4.56, avg_maintenance_conditions: 2.69, avg_repair_conditions: 1.95, avg_images: 29.24, avg_edited_images: 0.73, rate_edited_images: 0.0251, rate_recommendations_with_image: 0.7794 },
      { vehicle_age_range: "0 3 Years", mileage_range: "50K-100K", inspection_count: 520, avg_issues_found: 8.12, avg_maintenance_conditions: 5.42, avg_repair_conditions: 4.03, avg_images: 32.97, avg_edited_images: 0.81, rate_edited_images: 0.0246, rate_recommendations_with_image: 0.7791 },
      { vehicle_age_range: "0 3 Years", mileage_range: "100K-150K", inspection_count: 48, avg_issues_found: 10.9, avg_maintenance_conditions: 7.06, avg_repair_conditions: 6.25, avg_images: 35.38, avg_edited_images: 0.06, rate_edited_images: 0.0018, rate_recommendations_with_image: 0.744 },
      { vehicle_age_range: "0 3 Years", mileage_range: "150K+", inspection_count: 16, avg_issues_found: 11.69, avg_maintenance_conditions: 7.62, avg_repair_conditions: 6.62, avg_images: 38.19, avg_edited_images: 0.19, rate_edited_images: 0.0049, rate_recommendations_with_image: 0.7526 },
      { vehicle_age_range: "4 6 Years", mileage_range: "0-50K", inspection_count: 1111, avg_issues_found: 6.86, avg_maintenance_conditions: 4.19, avg_repair_conditions: 3.33, avg_images: 32.38, avg_edited_images: 0.85, rate_edited_images: 0.0263, rate_recommendations_with_image: 0.7857 },
      { vehicle_age_range: "4 6 Years", mileage_range: "50K-100K", inspection_count: 2163, avg_issues_found: 9.29, avg_maintenance_conditions: 5.79, avg_repair_conditions: 5.04, avg_images: 33.6, avg_edited_images: 1.32, rate_edited_images: 0.0392, rate_recommendations_with_image: 0.7917 },
      { vehicle_age_range: "4 6 Years", mileage_range: "100K-150K", inspection_count: 657, avg_issues_found: 11.09, avg_maintenance_conditions: 6.1, avg_repair_conditions: 6.91, avg_images: 33.7, avg_edited_images: 1.67, rate_edited_images: 0.0495, rate_recommendations_with_image: 0.7894 },
      { vehicle_age_range: "4 6 Years", mileage_range: "150K+", inspection_count: 107, avg_issues_found: 10.03, avg_maintenance_conditions: 5.29, avg_repair_conditions: 6.79, avg_images: 31.08, avg_edited_images: 1.36, rate_edited_images: 0.0439, rate_recommendations_with_image: 0.7562 },
      { vehicle_age_range: "7 10 Years", mileage_range: "0-50K", inspection_count: 561, avg_issues_found: 7.63, avg_maintenance_conditions: 4.5, avg_repair_conditions: 4.21, avg_images: 31.35, avg_edited_images: 1.36, rate_edited_images: 0.0434, rate_recommendations_with_image: 0.8002 },
      { vehicle_age_range: "7 10 Years", mileage_range: "50K-100K", inspection_count: 2524, avg_issues_found: 10.08, avg_maintenance_conditions: 5.88, avg_repair_conditions: 5.93, avg_images: 33.72, avg_edited_images: 1.33, rate_edited_images: 0.0396, rate_recommendations_with_image: 0.8002 },
      { vehicle_age_range: "7 10 Years", mileage_range: "100K-150K", inspection_count: 2431, avg_issues_found: 11.58, avg_maintenance_conditions: 6.44, avg_repair_conditions: 7.59, avg_images: 35.56, avg_edited_images: 1.53, rate_edited_images: 0.0431, rate_recommendations_with_image: 0.7985 },
      { vehicle_age_range: "7 10 Years", mileage_range: "150K+", inspection_count: 974, avg_issues_found: 11.8, avg_maintenance_conditions: 6.11, avg_repair_conditions: 8.03, avg_images: 34.42, avg_edited_images: 1.62, rate_edited_images: 0.047, rate_recommendations_with_image: 0.7972 },
      { vehicle_age_range: "10 Years", mileage_range: "0-50K", inspection_count: 787, avg_issues_found: 7.55, avg_maintenance_conditions: 3.92, avg_repair_conditions: 5.0, avg_images: 29.01, avg_edited_images: 0.85, rate_edited_images: 0.0294, rate_recommendations_with_image: 0.7988 },
      { vehicle_age_range: "10 Years", mileage_range: "50K-100K", inspection_count: 1529, avg_issues_found: 10.48, avg_maintenance_conditions: 5.67, avg_repair_conditions: 6.55, avg_images: 33.17, avg_edited_images: 1.54, rate_edited_images: 0.0466, rate_recommendations_with_image: 0.8053 },
      { vehicle_age_range: "10 Years", mileage_range: "100K-150K", inspection_count: 3323, avg_issues_found: 12.12, avg_maintenance_conditions: 6.32, avg_repair_conditions: 8.38, avg_images: 34.85, avg_edited_images: 1.67, rate_edited_images: 0.0479, rate_recommendations_with_image: 0.8046 },
      { vehicle_age_range: "10 Years", mileage_range: "150K+", inspection_count: 4184, avg_issues_found: 13.17, avg_maintenance_conditions: 6.4, avg_repair_conditions: 9.61, avg_images: 36.03, avg_edited_images: 1.66, rate_edited_images: 0.0461, rate_recommendations_with_image: 0.8057 }
    ];

    const ageOrder = ["0 3 Years", "4 6 Years", "7 10 Years", "10 Years"];
    const mileageOrder = ["0-50K", "50K-100K", "100K-150K", "150K+"];

    const metricLabels = {
      avg_issues_found: 'Avg Issues Found',
      avg_maintenance_conditions: 'Avg Maintenance Conditions',
      avg_repair_conditions: 'Avg Repair Conditions',
      avg_images: 'Avg Images',
      avg_edited_images: 'Avg Edited Images',
      rate_recommendations_with_image: 'Recommendations w/ Image Rate',
      rate_edited_images: 'Edited Image Rate'
    };

    const gradeColors = {
      'Excellent': '#10b981',
      'Good': '#3b82f6',
      'Needs Improvement': '#f59e0b',
      'Poor': '#ef4444'
    };

    let explorerChart = null;
    let distributionChart = null;
    let segmentChart = null;

    // Tab switching
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
        btn.classList.add('active');
        document.getElementById(btn.dataset.tab + '-tab').classList.remove('hidden');
        
        if (btn.dataset.tab === 'simulator') {
          updateSimulator();
        }
      });
    });

    // Explorer functions
    function getFilteredData() {
      const ageFilter = document.getElementById('ageFilter').value;
      const mileageFilter = document.getElementById('mileageFilter').value;
      
      return rawData.filter(d => {
        if (ageFilter !== 'all' && d.vehicle_age_range !== ageFilter) return false;
        if (mileageFilter !== 'all' && d.mileage_range !== mileageFilter) return false;
        return true;
      });
    }

    function getAggregatedData() {
      const groupBy = document.getElementById('groupBy').value;
      const filteredData = getFilteredData();
      
      if (groupBy === 'age') {
        return ageOrder.map(age => {
          const items = filteredData.filter(d => d.vehicle_age_range === age);
          const total = items.reduce((sum, d) => sum + d.inspection_count, 0);
          if (total === 0) return null;
          const result = { name: age, inspection_count: total };
          Object.keys(metricLabels).forEach(metric => {
            result[metric] = items.reduce((sum, d) => sum + d[metric] * d.inspection_count, 0) / total;
          });
          return result;
        }).filter(Boolean);
      } else if (groupBy === 'mileage') {
        return mileageOrder.map(mileage => {
          const items = filteredData.filter(d => d.mileage_range === mileage);
          const total = items.reduce((sum, d) => sum + d.inspection_count, 0);
          if (total === 0) return null;
          const result = { name: mileage, inspection_count: total };
          Object.keys(metricLabels).forEach(metric => {
            result[metric] = items.reduce((sum, d) => sum + d[metric] * d.inspection_count, 0) / total;
          });
          return result;
        }).filter(Boolean);
      } else {
        return filteredData.map(d => ({
          ...d,
          name: `${d.vehicle_age_range} / ${d.mileage_range}`
        })).sort((a, b) => {
          const ageA = ageOrder.indexOf(a.vehicle_age_range);
          const ageB = ageOrder.indexOf(b.vehicle_age_range);
          if (ageA !== ageB) return ageA - ageB;
          return mileageOrder.indexOf(a.mileage_range) - mileageOrder.indexOf(b.mileage_range);
        });
      }
    }

    function updateExplorer() {
      const metric = document.getElementById('metricSelect').value;
      const data = getAggregatedData();
      const isRate = metric.includes('rate');
      
      document.getElementById('chart-title').textContent = metricLabels[metric] + ' by Segment';
      document.getElementById('total-inspections').textContent = data.reduce((sum, d) => sum + d.inspection_count, 0).toLocaleString();
      
      // Update chart
      if (explorerChart) explorerChart.destroy();
      
      const ctx = document.getElementById('explorerChart').getContext('2d');
      explorerChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: data.map(d => d.name),
          datasets: [{
            label: metricLabels[metric],
            data: data.map(d => isRate ? d[metric] * 100 : d[metric]),
            backgroundColor: '#3b82f6'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            tooltip: {
              callbacks: {
                label: (context) => isRate ? `${context.raw.toFixed(1)}%` : context.raw.toFixed(2)
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: (value) => isRate ? `${value}%` : value
              }
            }
          }
        }
      });

      // Update table
      const tbody = document.getElementById('dataTableBody');
      tbody.innerHTML = data.map((row, i) => `
        <tr class="${i % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
          <td class="px-4 py-2 font-medium">${row.name}</td>
          <td class="px-4 py-2 text-right">${row.inspection_count.toLocaleString()}</td>
          <td class="px-4 py-2 text-right">${row.avg_issues_found.toFixed(1)}</td>
          <td class="px-4 py-2 text-right">${row.avg_maintenance_conditions.toFixed(1)}</td>
          <td class="px-4 py-2 text-right">${row.avg_repair_conditions.toFixed(1)}</td>
          <td class="px-4 py-2 text-right">${row.avg_images.toFixed(1)}</td>
          <td class="px-4 py-2 text-right">${(row.rate_edited_images * 100).toFixed(1)}%</td>
          <td class="px-4 py-2 text-right">${(row.rate_recommendations_with_image * 100).toFixed(1)}%</td>
        </tr>
      `).join('');
    }

    // Benchmarks functions
    function getHeatColor(value, metric) {
      const thresholds = {
        avg_issues_found: { low: 6, mid: 10, high: 13 },
        avg_images: { low: 28, mid: 33, high: 38 },
        rate_recommendations_with_image: { low: 0.75, mid: 0.80, high: 0.85 }
      };
      const t = thresholds[metric];
      if (!t) return '';
      if (metric === 'avg_images' || metric === 'rate_recommendations_with_image') {
        if (value >= t.high) return 'heat-good';
        if (value >= t.mid) return 'heat-ok';
        return 'heat-bad';
      } else {
        if (value <= t.low) return 'heat-good';
        if (value <= t.mid) return 'heat-ok';
        return 'heat-bad';
      }
    }

    function renderHeatmaps() {
      const container = document.getElementById('heatmapContainer');
      const metrics = ['avg_issues_found', 'avg_images', 'rate_recommendations_with_image'];
      const metricNames = {
        avg_issues_found: 'Average Issues Found',
        avg_images: 'Average Images',
        rate_recommendations_with_image: 'Rate: Recommendations with Image'
      };

      container.innerHTML = metrics.map(metric => {
        const isRate = metric.includes('rate');
        return `
          <div class="bg-white rounded-lg shadow p-4">
            <h4 class="font-semibold mb-3">${metricNames[metric]}</h4>
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead>
                  <tr>
                    <th class="p-2 text-left bg-gray-100">Age / Mileage</th>
                    ${mileageOrder.map(m => `<th class="p-2 text-center bg-gray-100">${m}</th>`).join('')}
                  </tr>
                </thead>
                <tbody>
                  ${ageOrder.map(age => `
                    <tr>
                      <td class="p-2 font-medium bg-gray-50">${age}</td>
                      ${mileageOrder.map(mileage => {
                        const item = rawData.find(d => d.vehicle_age_range === age && d.mileage_range === mileage);
                        const value = item ? item[metric] : null;
                        const colorClass = item ? getHeatColor(value, metric) : 'bg-gray-100';
                        return `
                          <td class="p-2 text-center ${colorClass}">
                            ${value !== null ? (isRate ? `${(value * 100).toFixed(0)}%` : value.toFixed(1)) : '-'}
                            ${item ? `<div class="text-xs text-gray-500">(n=${item.inspection_count})</div>` : ''}
                          </td>
                        `;
                      }).join('')}
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
            <div class="flex gap-4 mt-2 text-xs">
              <span class="flex items-center gap-1"><span class="w-3 h-3 heat-good rounded"></span> Good</span>
              <span class="flex items-center gap-1"><span class="w-3 h-3 heat-ok rounded"></span> Acceptable</span>
              <span class="flex items-center gap-1"><span class="w-3 h-3 heat-bad rounded"></span> Needs Improvement</span>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderThresholds() {
      const tbody = document.getElementById('thresholdsTableBody');
      const rows = rawData.map(d => {
        const ageIndex = ageOrder.indexOf(d.vehicle_age_range);
        const mileageIndex = mileageOrder.indexOf(d.mileage_range);
        const riskLevel = (ageIndex + mileageIndex) / 6;
        return {
          ...d,
          risk_level: riskLevel,
          expected_issues_min: Math.round(6 + riskLevel * 10),
          expected_issues_max: Math.round(6 + riskLevel * 12),
          expected_maint_min: Math.round(4 + riskLevel * 4),
          expected_maint_max: Math.round(4 + riskLevel * 5),
          expected_repair_min: Math.round(3 + riskLevel * 6),
          expected_repair_max: Math.round(3 + riskLevel * 8),
          min_images: Math.round(32 + riskLevel * 10),
          target_images: Math.round(32 + riskLevel * 12)
        };
      }).sort((a, b) => a.risk_level - b.risk_level);

      tbody.innerHTML = rows.map((row, i) => `
        <tr class="${i % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
          <td class="px-3 py-2 font-medium">${row.vehicle_age_range}</td>
          <td class="px-3 py-2">${row.mileage_range}</td>
          <td class="px-3 py-2 text-center">${row.expected_issues_min}-${row.expected_issues_max}</td>
          <td class="px-3 py-2 text-center">${row.expected_maint_min}-${row.expected_maint_max}</td>
          <td class="px-3 py-2 text-center">${row.expected_repair_min}-${row.expected_repair_max}</td>
          <td class="px-3 py-2 text-center font-semibold text-blue-600">${row.min_images}</td>
          <td class="px-3 py-2 text-center font-semibold text-green-600">${row.target_images}</td>
          <td class="px-3 py-2 text-center">85%</td>
        </tr>
      `).join('');
    }

    document.getElementById('matrixViewBtn').addEventListener('click', () => {
      document.getElementById('matrixViewBtn').classList.add('bg-blue-500', 'text-white');
      document.getElementById('matrixViewBtn').classList.remove('bg-gray-200');
      document.getElementById('thresholdsViewBtn').classList.remove('bg-blue-500', 'text-white');
      document.getElementById('thresholdsViewBtn').classList.add('bg-gray-200');
      document.getElementById('matrixView').classList.remove('hidden');
      document.getElementById('thresholdsView').classList.add('hidden');
    });

    document.getElementById('thresholdsViewBtn').addEventListener('click', () => {
      document.getElementById('thresholdsViewBtn').classList.add('bg-blue-500', 'text-white');
      document.getElementById('thresholdsViewBtn').classList.remove('bg-gray-200');
      document.getElementById('matrixViewBtn').classList.remove('bg-blue-500', 'text-white');
      document.getElementById('matrixViewBtn').classList.add('bg-gray-200');
      document.getElementById('thresholdsView').classList.remove('hidden');
      document.getElementById('matrixView').classList.add('hidden');
    });

    // Simulator functions
    function getWeights() {
      return {
        issues: parseInt(document.getElementById('weight_issues').value),
        maint: parseInt(document.getElementById('weight_maint').value),
        repair: parseInt(document.getElementById('weight_repair').value),
        images: parseInt(document.getElementById('weight_images').value),
        recimg: parseInt(document.getElementById('weight_recimg').value)
      };
    }

    function getThresholds() {
      return {
        excellent: parseInt(document.getElementById('threshold_excellent').value),
        good: parseInt(document.getElementById('threshold_good').value),
        needs: parseInt(document.getElementById('threshold_needs').value)
      };
    }

    function calculateScores() {
      const weights = getWeights();
      const thresholds = getThresholds();
      const totalWeight = Object.values(weights).reduce((a, b) => a + b, 0);

      return rawData.map(d => {
        const ageIndex = ageOrder.indexOf(d.vehicle_age_range);
        const mileageIndex = mileageOrder.indexOf(d.mileage_range);
        const riskLevel = (ageIndex + mileageIndex) / 6;

        const expectedIssues = 6 + riskLevel * 12;
        const expectedMaint = 4 + riskLevel * 5;
        const expectedRepair = 3 + riskLevel * 8;
        const minImages = 32 + riskLevel * 12;
        const targetRecWithImage = 0.85;

        const issuesScore = Math.min(100, (d.avg_issues_found / expectedIssues) * 100);
        const maintScore = Math.min(100, (d.avg_maintenance_conditions / expectedMaint) * 100);
        const repairScore = Math.min(100, (d.avg_repair_conditions / expectedRepair) * 100);
        const imagesScore = Math.min(100, (d.avg_images / minImages) * 100);
        const recImageScore = Math.min(100, (d.rate_recommendations_with_image / targetRecWithImage) * 100);

        const totalScore = (
          issuesScore * (weights.issues / totalWeight) +
          maintScore * (weights.maint / totalWeight) +
          repairScore * (weights.repair / totalWeight) +
          imagesScore * (weights.images / totalWeight) +
          recImageScore * (weights.recimg / totalWeight)
        );

        let grade;
        if (totalScore >= thresholds.excellent) grade = 'Excellent';
        else if (totalScore >= thresholds.good) grade = 'Good';
        else if (totalScore >= thresholds.needs) grade = 'Needs Improvement';
        else grade = 'Poor';

        return {
          ...d,
          score: Math.round(totalScore),
          issuesScore: Math.round(issuesScore),
          maintScore: Math.round(maintScore),
          repairScore: Math.round(repairScore),
          imagesScore: Math.round(imagesScore),
          recImageScore: Math.round(recImageScore),
          grade
        };
      });
    }

    function updateSimulator() {
      const weights = getWeights();
      const thresholds = getThresholds();
      const totalWeight = Object.values(weights).reduce((a, b) => a + b, 0);
      const scoredData = calculateScores();

      // Update weight displays
      document.getElementById('weight_issues_val').textContent = weights.issues + '%';
      document.getElementById('weight_maint_val').textContent = weights.maint + '%';
      document.getElementById('weight_repair_val').textContent = weights.repair + '%';
      document.getElementById('weight_images_val').textContent = weights.images + '%';
      document.getElementById('weight_recimg_val').textContent = weights.recimg + '%';

      // Update threshold displays
      document.getElementById('threshold_excellent_val').textContent = thresholds.excellent;
      document.getElementById('threshold_good_val').textContent = thresholds.good;
      document.getElementById('threshold_needs_val').textContent = thresholds.needs;
      document.getElementById('excellent_desc').textContent = `Score ‚â• ${thresholds.excellent}`;
      document.getElementById('good_desc').textContent = `Score ‚â• ${thresholds.good}`;
      document.getElementById('needs_desc').textContent = `Score ‚â• ${thresholds.needs}`;
      document.getElementById('poor_threshold').textContent = thresholds.needs;

      // Update total weight indicator
      const indicator = document.getElementById('totalWeightIndicator');
      if (totalWeight === 100) {
        indicator.className = 'mt-4 p-2 rounded text-sm bg-green-100 text-green-800';
        indicator.textContent = 'Total Weight: 100%';
      } else {
        indicator.className = 'mt-4 p-2 rounded text-sm bg-yellow-100 text-yellow-800';
        indicator.textContent = `Total Weight: ${totalWeight}% (will be normalized to 100%)`;
      }

      // Calculate distribution
      const dist = { Excellent: 0, Good: 0, 'Needs Improvement': 0, Poor: 0 };
      scoredData.forEach(d => { dist[d.grade] += d.inspection_count; });
      const total = Object.values(dist).reduce((a, b) => a + b, 0);

      // Update distribution chart
      if (distributionChart) distributionChart.destroy();
      const distCtx = document.getElementById('distributionChart').getContext('2d');
      distributionChart = new Chart(distCtx, {
        type: 'bar',
        data: {
          labels: Object.keys(dist),
          datasets: [{
            data: Object.values(dist),
            backgroundColor: Object.keys(dist).map(k => gradeColors[k])
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } }
        }
      });

      // Update legend
      document.getElementById('distributionLegend').innerHTML = Object.entries(dist).map(([name, count]) => `
        <span class="flex items-center gap-1">
          <span class="w-3 h-3 rounded" style="background-color: ${gradeColors[name]}"></span>
          ${name}: ${((count / total) * 100).toFixed(1)}%
        </span>
      `).join('');

      // Update segment chart
      const sortedData = [...scoredData].sort((a, b) => a.score - b.score);
      if (segmentChart) segmentChart.destroy();
      const segCtx = document.getElementById('segmentChart').getContext('2d');
      segmentChart = new Chart(segCtx, {
        type: 'bar',
        data: {
          labels: sortedData.map(d => `${d.vehicle_age_range.slice(0,5)}/${d.mileage_range}`),
          datasets: [{
            data: sortedData.map(d => d.score),
            backgroundColor: sortedData.map(d => gradeColors[d.grade])
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: { x: { max: 100 } }
        }
      });

      // Update score table
      const tbody = document.getElementById('scoreTableBody');
      tbody.innerHTML = [...scoredData].sort((a, b) => b.score - a.score).map((row, i) => `
        <tr class="${i % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
          <td class="px-3 py-2 font-medium">${row.vehicle_age_range} / ${row.mileage_range}</td>
          <td class="px-3 py-2 text-center text-gray-500">${row.inspection_count.toLocaleString()}</td>
          <td class="px-3 py-2 text-center">${row.issuesScore}</td>
          <td class="px-3 py-2 text-center">${row.maintScore}</td>
          <td class="px-3 py-2 text-center">${row.repairScore}</td>
          <td class="px-3 py-2 text-center">${row.imagesScore}</td>
          <td class="px-3 py-2 text-center">${row.recImageScore}</td>
          <td class="px-3 py-2 text-center font-bold">${row.score}</td>
          <td class="px-3 py-2 text-center">
            <span class="px-2 py-1 rounded text-xs text-white" style="background-color: ${gradeColors[row.grade]}">${row.grade}</span>
          </td>
        </tr>
      `).join('');
    }

    // Event listeners for explorer
    ['groupBy', 'ageFilter', 'mileageFilter', 'metricSelect'].forEach(id => {
      document.getElementById(id).addEventListener('change', updateExplorer);
    });

    // Event listeners for simulator
    ['weight_issues', 'weight_maint', 'weight_repair', 'weight_images', 'weight_recimg',
     'threshold_excellent', 'threshold_good', 'threshold_needs'].forEach(id => {
      document.getElementById(id).addEventListener('input', updateSimulator);
    });

    // Initialize
    updateExplorer();
    renderHeatmaps();
    renderThresholds();
  </script>
</body>
</html>
